name: CI
on:
  push:
    branches: 
    - main

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: get_code
              uses: actions/checkout@v4

            - name: Configure AWS CLI
              run: |
                aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws configure set region ${{ secrets.AWS_REGION }}

            - name: Login to AWS ECR
              uses: aws-actions/amazon-ecr-login@v1

            - env:
                ENV: ${{ secrets.BACKEND }}
              run: echo -e "$ENV">.env

            - name: Build and Push Docker Image
              run: |
                    docker build -t golu .
                    docker tag golu:latest 423755636060.dkr.ecr.ap-south-1.amazonaws.com/golu:latest
                    docker push 423755636060.dkr.ecr.ap-south-1.amazonaws.com/golu:latest

    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Set up SSH key for EC2 access
              run: |
                    mkdir -p ~/.ssh
                    echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                    chmod 600 ~/.ssh/id_rsa

            - name: SSH into EC2 and execute commands 
              run: |
                    ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}  << 'EOF'
                    set -e
                    echo "Docker Login"
                    aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 400908163598.dkr.ecr.us-east-2.amazonaws.com
                    docker pull 423755636060.dkr.ecr.ap-south-1.amazonaws.com/golu:latest
                    echo "pull done"
                    docker logout 
                    echo "removing older container"
                    docker rm -f 423755636060.dkr.ecr.ap-south-1.amazonaws.com/golu:latest
                    echo "done"
                    echo "Running New container"
                    sudo docker run -d --name golu-react-webapp -p 8080:8080 423755636060.dkr.ecr.ap-south-1.amazonaws.com/golu:latest
                    echo "Done" 
                    

  
